<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>车票订单--已完成订单</title>
    <link href="{{url_for('static', filename='admin-new/css/style.css')}}" rel="stylesheet" type="text/css" />
    <link href="{{url_for('static', filename='admin-new/css/select.css')}}" rel="stylesheet" type="text/css" />
    <script language="JavaScript" src="{{url_for('static', filename='admin-new/js/jquery.js')}}"></script>
    <script type="text/javascript" src="{{url_for('static', filename='admin-new/js/select-ui.min.js')}}"></script>
    <script type="text/javascript" src="{{url_for('static',filename='admin-new/js/datepicker/WdatePicker.js')}}"></script>
    <script type="text/javascript" src="{{url_for('static',filename='admin-new/js/layer/layer.js')}}"></script>
    <script language="javascript">
        $(function (){
			//全选
			$("#checkall").checkall({ chname: "test[]", callback: function (e) { } });

			$(".single-select").uedSelect({width : 240});
			$('.J_close').on('click', function(){
				var is_switch = 0;
				var	_this = $(this);
				if(_this.attr('data-status')==0){
					is_switch = 1;
          run();
        }
				$.ajax({
					url : '/kefu_on_off',
					type : 'post',
					data : {
						is_switch : is_switch
					},
					success : function(data){
						if(data.status==0){
              set_switch(data["is_switch"]);
              load_orders();
					    }
				    }
				});
			  });
       })

          function disp_confirm(order_no)
		    {
			  var r=confirm('确定已支付?')
			  if (r==true)
			    {
			    $.ajax({
					url : '/kefu_complete',
					type : 'post',
					data : {
						 order_no:order_no
					},
					success : function(data){
						if(data.status==0){
							parent.location.reload();
					    }
				    }
				});
			    }
			  }

          function kefu_reflesh_order(order_no)
		    {
			    $.ajax({
					url : '/kefu_reflesh_order',
					type : 'post',
					data : {
						 order_no:order_no
					},
					success : function(data){
						if(data.status==0){
              load_orders();
					    }
				    }
				});
			  }

	    function run(){
          if($("#switch_button").attr("data-status") == 0){
            return
          }
           var s = document.getElementById("timeout");
           if(s.innerHTML == 0){
              load_orders();
              s.innerHTML = 30;
           }else{
              s.innerHTML = s.innerHTML * 1 - 1;
           }
           }
           window.setInterval("run();", 1000);
    </script>
</head>
<body>
    <div class="place">
        <span>位置：</span>
         <ul class="placeul">
            <li><a href="#">车票订单</a></li>
            <li><a href="#">我的订单</a></li>
        </ul>
    </div>

    <div class="formbody">
             <div class="itab" >
                <ul id='itab'>
                    <li><a href="#tab1" class="selected"  >待处理订单</a></li>
                    <!-- <li><a href="#tab2" >已处理订单</a></li>  -->
               </ul>
            </div>
   <!--查询条件-->
   <div id='tab2' class="tabson2">
   <div id='tab1' class="tabson">
    <ul class="seachform">
    <li>
      <label class="timecount">自动刷新，距离下次刷新还剩<em id = 'timeout'>30</em> 秒</label>
    </li>

    <li  class="right"><label>&nbsp;</label>
	 	  <input  id="switch_button" name="" type="button" class="b_btn J_close" data-status="1" value="开始接单"/>
    </li>
    </ul>
   </div>

    <div id="wating-deal-table">
    </div>
    </div>

    <div id="btsizebox" style="display: none">
        <div class="regbox_bd">
            <div class="signup_hd">
                <h2>选择登陆账号<span>账号登陆不进，直接<a>登陆官网</a></span></h2>
            </div>
            <div class="signup_box">
                <form method="post" action="#" id="formPublic">
                    <div class="pub-form reg-form">
                        <div class="fm-li pbot-5">
                            <span class="fm-label">
                                <label for="txt_userName">我的账号：</label></span>
                            <select name="levelName" id="levelName" datatype="*" sucmsg=" " class="single-select">
                                <option value="2">1895545668(牧师)</option>
                            </select>

                        </div>

                        <div class="fm-li pbot-5">
                            <span class="fm-label">
                                <label for="txt_input6">验证码：</label></span>
                            <div class="code_box">
                                <input value="" name="verifyCode" id="verifyCode" class="i-input w220" type="text">
                            </div>
                        </div>

                        <div class="fm-li pbot-5">
                            <span class="fm-label"></span>
                            <span class="code_img">
                                <img alt="" class="regimg" src="#" id="imgVerifyCode"></span>
                        </div>

                        <input value="" id="id-order" type="hidden">
                        <div class="fm-li">
                            <span class="fm-label">
                                <label for="txt_input6"></label>
                            </span>
                            <input onclick="javascript:mainfm.rightFrame.pay($('#id-order').val(), $('#verifyCode').val());" name="" value="提交订单" class="btn_login" id="btn_submit" type="button">
                        </div>
                    </div>
                </form>
            </div>
            <p class="signup_bot">正在尝试下单，来着12308汽车票</p>
        </div>
    </div>

<script languge="javascript">

$(function (){
  load_orders();
  set_switch({{current_user.is_switch}});
});

function load_orders(){
  $("#wating-deal-table").load("{{url_for('admin.wating_deal_order')}}");
}

function set_switch(i){
    var cls="g_btn J_close";
    var v="1";
    var text = "结束接单"
    if(i==0){
      cls="b_btn J_close";
      v="0";
      text = "开始接单"
    }
    $("#switch_button").attr("class", cls);
    $("#switch_button").attr("data-status", v);
    $("#switch_button").val(text);
}

function pay(order_no, code){
  var query=""
  if(code){
      query = "?valid_code="+code
  }
  var base_url= "/orders/"+order_no+"/pay";
  $.ajax({
      type: "get",
      url: "/orders/"+order_no+"/pay"+query,
      dataType: "json",
      success: function (data) {
        if(data.status=="OK"){
          parent.parent.layer.closeAll();
          newWindow = window.open("/404","","");
          newWindow.document.write(data.data);
        }else if(data.status=="code_error"){
          $("#imgVerifyCode").attr("src", data.data)
          $("#id-order").val(order_no);
          parent.parent.layer.closeAll();
          parent.parent.layer.open({
                type: 1,
                title:'登录手动下单',
                area: ['580px', ''],
                //skin: 'layui-layer-lan',
                moveType: 1, //拖拽风格，0是默认，1是传统拖动
                shift: 0, //0-6的动画形式，-1不开启
                content: $("#btsizebox").html()
          });
        }else{
          parent.parent.layer.closeAll();
          alert(data.msg);
        }
      }, error: function (XMLHttpRequest, textStatus, errorThrown) { alert(errorThrown);
      }
  });
}
</script>
</body>
</html>

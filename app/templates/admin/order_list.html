{% extends 'admin/list.html' %}

{% block content%}

<div class="row">
  <div class="col-xs-4"><div class="dataTables_info" id="example_info">总共 {{page.total}} 个订单</div></div>
  <div class="col-xs-4">
    <div class="dataTables_filter" id="example_filter">
      <label>订单号:&nbsp;&nbsp; <input type="text" id="in_orderno" value="{{order_no}}" onchange="search()"></label>
    </div>
  </div>
</div>

<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered dataTable" id="example">

<thead>
	<tr role="row">
	<th class="sorting_asc" role="columnheader" tabindex="0" rowspan="1" colspan="1" style="width: 137px;">订单号</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 120px;">联系人</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 120px;">源网站/支付账号</th>
	<th class="sorting" role="columnheader" tabindex="0" rowspan="1" colspan="1" style="width: 210px;">下单时间/出发时间</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 150px;">车次/线路</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 100px;">订单状态</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 100px;">订单锁票信息</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 100px;">订票数</th>
	<th class="sorting" role="columnheader" tabindex="0"  rowspan="1" colspan="1" style="width: 100px;">订单金额(元)</th>
	<th class="sorting" role="columnheader" tabindex="0" rowspan="1" colspan="1" style="width: 160px;">操作</th>
	</tr>
</thead>

<tbody role="alert">
	{% for order in page["items"] %}
		<tr class="gradeA {{i}}">
			<td class="sorting_1">{{order.order_no}}</td>
      <td class="center">{{order.contact_info.name}} {{order.contact_info.telephone}}</td>
      <td class="center">{{source_msg[order.crawl_source]}}({{order.source_account}}/{{scqcp_accounts[order.source_account]|first}})</td>
      <td class="center">{{order.create_date_time|format_datetime('%Y-%m-%d %H:%M:%S')}}/{{order.line.drv_date}} {{order.line.drv_time}}</td>
      <td class="center">{{order.line.bus_num}}/{{order.line.starting.city_name}} --> {{order.line.destination.station_name}}</td>
      <td class="center">{{status_msg[order.status]}}</td>
      
      <td class="center">
      {% if order.status ==3 %}
      	{{order.lock_info.get('expire_time','')}} 过期
      {%elif order.status ==5 %}
      	{{order.lock_info.get('returnMsg','') or order.lock_info.get('msg','')   }}
      {%elif order.status == 0%}
      	{% if order.lock_info.get('expire_time','')  %}
      		订单支付超时
      	{%endif %}	
      {%endif %}
      </td>
      <td class="center">{{order.ticket_amount}}</td>
      <td class="center">{{order.order_price}}</td>
			<td class="">
        <a class="btn btn-primary btn-xs" href="orders/{{order.order_no}}/pay" target="_blank"><i class="glyphicon glyphicon-pencil"></i> 支付</a>
        <a class="btn btn-primary btn-xs" href="#" onclick="pay({{order.order_no}}, '')"><i class="glyphicon glyphicon-pencil"></i> 支付</a>
				<a class="btn btn-danger btn-xs" href="orders/{{order.order_no}}/refresh"><i class="glyphicon glyphicon-refresh"></i> 刷新</a>
        <div id="id_code">
        </div>
			</td>
		</tr>
	{%endfor%}
</tbody>
</table>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">New message</h4>
      </div>
      <div class="modal-body">
          <img src="#" alt="validCode"/ id="img-code">
          <div class="form-group">
            <label for="recipient-name" class="control-label">输入验证码:</label>
            <input type="text" class="form-control" id="id-code">
            <input type="hidden" class="form-control" id="id-order">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="pay2()">确认</button>
      </div>
    </div>
  </div>
</div>
{%endblock%}


{% block script %}
<script languge="javascript">
function search(){
  var no = $("#in_orderno").val();
  var url = "{{page.req_path2}}";
  if(no){
    url=url+"order_no="+no;
  }
  window.location.href = url;
};

function pay2(){
 $('#myModal').modal('hide');
  pay($("#id-order").val(), $("#id-code").val());
}

function pay(order_no, code){
  var query=""
  if(code){
      query = "?valid_code="+code
  }
  var base_url= "/orders/"+order_no+"/pay";
  $.ajax({
      type: "get",
      url: "/orders/"+order_no+"/pay"+query,
      dataType: "json",
      success: function (data) {
        alert("success"+data.status);
        if(data.status=="OK"){
          document.write(data.data);
        }else if(data.status=="code_error"){
          $("#img-code").attr("src", data.data)
          $("#id-order").val(order_no)
          $('#myModal').modal('show');
        }else{
          alert(data.msg);
        }
      }, error: function (XMLHttpRequest, textStatus, errorThrown) { alert(errorThrown);
      }
  });
}
</script>
 {%endblock%}

